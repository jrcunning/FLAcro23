---
title: "FLAcro23: Data analysis"
author: "Ross Cunning and Rich Karp"
output: html_document
date: "2024-09-26"
---

```{r}
library(lme4)
library(emmeans)
library(tidyverse)
library(cowplot)
```

## Import processed data
```{r}
# Processed data with sites for each data provider
df1 <- read_csv("data/processed/FLAcro23_data_processed_sites.csv") %>%
  mutate(subregion = factor(subregion, levels = c("Broward-Miami", "Biscayne", "Upper Keys",
                                                  "Middle Keys", "Lower Keys", "Tortugas--Dry Tortugas NP")))
# Processed data with sites clustered based on proximity
df <- read_csv("data/processed/FLAcro23_data_processed.csv") %>%
  mutate(subregion = factor(subregion, levels = c("Broward-Miami", "Biscayne", "Upper Keys",
                                                  "Middle Keys", "Lower Keys", "Tortugas--Dry Tortugas NP")))
```

# Map surveys over space and time
```{r map_data}
# Get the maximum number of ramets of each species ever surveyed (on one date) at a siteclust
# Get the sum of max total counted in each subregion
## This could underestimate, because diff sites in same siteclust surveyed on same date would be lost
dfs <- df %>%
  group_by(siteclust, subregion, species, coral_type) %>%
  summarize(maxn = max(n_total)) %>%
  mutate(maxn_cat = cut(maxn, breaks = c(0, 10, 100, 1000, 10000)))

counts1 <- dfs %>%
  group_by(subregion) %>%
  summarize(maxtot1 = sum(maxn))

# Get sum treating each original data_provider.sitename as unique site, and get max observed at that site (on any date),
# and total by subregion
## This could overestimate, because diff data_providers could have surveyed same site/same corals, but
## here they'd be treated as different sites
counts2 <- df1 %>%
  group_by(site, subregion, species, coral_type) %>%
  summarize(maxn = max(n_total)) %>%
  group_by(subregion) %>%
  summarize(maxtot2 = sum(maxn))

counts <- full_join(counts1, counts2)

# Plot map of Florida
# Download satellite map for Florida
world <- rnaturalearth::ne_countries(scale = "large", returnclass = "sf")
# Create base map of Florida
basemap <- ggplot() +
  geom_sf(data = world, lwd = 0.1, fill = "gray90") +
  scale_fill_gradient2(high = "firebrick1", mid = "yellow", low = "forestgreen", 
                       midpoint = 0.5, limits = c(0, 1), na.value = NA,
                       labels = scales::label_percent(), name = "Corals\nbleached") +
  theme(text = element_text(size = 10),
        axis.title = element_blank(),
        panel.background = element_rect(fill = "lightsteelblue1"),
        panel.border = element_rect(colour = "black", fill=NA),
        panel.grid = element_blank(),
        legend.position = c(0.2, 0.5),
        legend.background = element_blank())


# Plot max number of ACER and APAL surveyed at each site
mapfig <- basemap +
  coord_sf(xlim = c(-83.2, -79.8), ylim = c(24.3, 26.5), expand = FALSE) +
  geom_point(data = dfs, aes(x = lon, y = lat, color = subregion, size = maxn_cat, shape = species), alpha = 0.4) +
  theme(legend.position = "none")

mapfig

# # # Surveys over time
ggplot(df, aes(x = date, fill = subregion)) +
  geom_histogram() +
  scale_x_date(date_breaks = "months", date_labels = "%b") +
  theme_classic() +
  labs(y = "Number of sites surveyed")

# # Surveys by max DHW experienced anytime prior to survey
ggplot(df, aes(x = cummaxdhw, fill = subregion)) +
  geom_histogram() +
  theme_classic() +
  labs(y = "Number of sites surveyed")
```



# Mortality over time

### Plot mortality over time data
```{r plot_mort, fig.width = 8, fig.height = 9}
# Plot Percent mortality over time
(mort <- ggplot(df, aes(x = date, y = pct_mort, fill = subregion)) +
  geom_point(aes(size = log10(n_total), shape = coral_type), alpha = 0.4, stroke = 0.2) +
  scale_x_date(date_breaks = "months", date_labels = "%b") +
  scale_shape_manual(values = c(21, 22, 23)) +
  #scale_size_discrete(range = c(1,4)) +
  facet_grid(subregion~species) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = "Date", y = "Percent mortality"))


```

### Model mortality over time by species and subregion
```{r, fig.width = 8, fig.height = 9}
# Fit model using glm
mod.glm <- glm(cbind(n_dead, n_alive) ~ subregion * date * species, 
               family = "binomial", data = df)

# Fit model using glmer (sites as random factors)
# Rescale the date predictor
df$date_scaled <- scale(as.numeric(df$date))
mod.glmer <- glmer(cbind(n_dead, n_alive) ~ subregion * date_scaled * species + (1| siteclust/species),
                   family = binomial,
                   data = df)

# Get fitted values for glm
res.glm <- emmeans(mod.glm, specs = c("date", "subregion", "species"), type = "response",
               at = list(date = seq(min(df$date), max(df$date), by = "days")))
res.glm <- as.tibble(res.glm)

# Get fitted values for glmer
res.glmer <- emmeans(mod.glmer, specs = c("date_scaled", "subregion", "species"), type = "response",
               at = list(date_scaled = seq(-2.168304, 2.380493, 0.014)))
datesd <- sd(as.numeric(df$date))
datemean <- mean(as.numeric(df$date))
res.glmer <- as.tibble(res.glmer) %>% mutate(date = as_date(date_scaled * datesd + datemean))

# Filter fitted values to just the range of observed data for each species/subregion
date_ranges <- df %>%
  group_by(species, subregion) %>%
  summarize(start = min(date), end = max(date))

res.glm.f <- as.tibble(res.glm) %>%
  group_by(species, subregion) %>%
  nest() %>%
  left_join(date_ranges) %>%
  mutate(data.f = pmap(list(data, start, end), function(data, start, end) data %>% filter(date >= start, date <= max(end, as.Date("2024-03-02"))))) %>%
  dplyr::select(subregion, species, data.f) %>%
  unnest(data.f)

res.glmer.f <- as.tibble(res.glmer) %>%
  group_by(species, subregion) %>%
  nest() %>%
  left_join(date_ranges) %>%
  mutate(data.f = pmap(list(data, start, end), function(data, start, end) data %>% filter(date >= start, date <= max(end, as.Date("2024-03-02"))))) %>%
  dplyr::select(subregion, species, data.f) %>%
  unnest(data.f)
```

### Plot mortality over time by species and subregion
```{r, fig.width = 8, fig.height = 9}
# Fitted Percent mortality on October 1, and April 1st from GLM
glm_fitted_mort <- res.glm.f %>%
  ungroup() %>%
  filter(date %in% c("2023-10-01", "2024-03-01")) %>%
  dplyr::select(subregion, species, date, prob)

glmer_fitted_mort <- res.glmer.f %>%
  ungroup() %>%
  mutate(date=ymd(date))%>%
  filter(date %in% c(ymd("2023-10-01"), ymd("2024-03-01"))) %>%
  dplyr::select(subregion, species, date, prob)

# Plot model fits over raw data
mort +
  geom_line(data = res.glm.f, aes(y = prob)) +
  geom_line(data = res.glmer.f, aes(y = prob), lty = 2) +
  geom_vline(xintercept = c(as.Date("2023-10-01"), as.Date("2024-03-01")), lwd = 0.25, color = "gray70") +
  geom_text(data = glm_fitted_mort, aes(y = prob, label = scales::label_percent()(round(prob, 2)))) +
  geom_text(data = glmer_fitted_mort, aes(y = prob, label = scales::label_percent()(round(prob, 2))), fontface = "italic")

#ggsave("outputs/acerApalRegionMort.png", width=10, height=12)

# Make wide mortality table by subregion for each species
mortSpecTableWide <- glmer_fitted_mort %>%
  pivot_wider(id_cols = subregion, names_from = c(species, date), values_from = prob)

knitr::kable(mortSpecTableWide)
```

### Test for statistical differences in mortality curves between APAL and ACER
```{r apal_vs_acer, eval = FALSE, include = FALSE}
# Overall difference between species across whole time series
# reduced model without species -- compare to full model with LRT for significance of species
mod.glmer.nospp <- glmer(cbind(n_dead, n_alive) ~ subregion * date_scaled + (1| siteclust/species),
                         family = binomial,
                         data = df)
anova(mod.glmer, mod.glmer.nospp, test = "Chisq")
BIC(mod.glmer, mod.glmer.nospp)
### There is an overall effect of species...

# Difference between species on October 1st, 2023
# get date_scaled for October 1st
oct1_scaled <- df %>% filter(date == "2023-10-01") %>% pull(date_scaled) %>% unique(.)
emm1001 <- emmeans(mod.glmer, specs = "species", by = c("date_scaled", "subregion"),
               at = list(date_scaled = oct1_scaled))
rbind(contrast(emm1001, "pairwise"))
# No differences between species in any subregion on Oct 1, 2023

# Difference between species on March 1st, 2024
# get date_scaled for March 1st
mar1_scaled <- df %>% filter(date == "2024-03-01") %>% pull(date_scaled) %>% unique(.)
emm0301 <- emmeans(mod.glmer, specs = "species", by = c("date_scaled", "subregion"),
               at = list(date_scaled = mar1_scaled))
rbind(contrast(emm0301, "pairwise"))
# No differences between species in any subregion on Mar 1, 2024. (at p=0.01... Biscayne is almost sig at p=0.0291)
```

### Model mortality of all Acropora over time, since no species diffs at dates of interest
```{r}
# Fit model using glmer (sites as random)
mod.all.glmer <- glmer(cbind(n_dead, n_alive) ~ subregion * date_scaled + (1|siteclust),  # OR (1|siteclust/species)
                       family = binomial, data = df)

# Fitted values for glmer
res.all.glmer <- emmeans(mod.all.glmer, specs = c("date_scaled", "subregion"), type = "response",
                         at = list(date_scaled = seq(-2.699, 2.167, 0.015)))

# Filter fitted values to just the range of observed data
date_ranges_scaled <- df %>%
  group_by(subregion) %>%
  summarize(start = min(date_scaled), end = max(date_scaled))
res.all.glmer.f <- as.tibble(res.all.glmer) %>%
  group_by(subregion) %>%
  nest() %>%
  left_join(date_ranges_scaled) %>%
  mutate(data.f = pmap(list(data, start, end), function(data, start, end) data %>% filter(date_scaled > start))) %>% #, date < end))) %>%
  dplyr::select(subregion, data.f) %>%
  unnest(data.f) %>%
  mutate(date = as_date(date_scaled * datesd + datemean))

# Pull out Oct1 and Mar1 mortality for each region using GLMER
out.glmer <- as.tibble(res.all.glmer.f) %>%
  mutate(date=ymd(date))%>%
  filter(date %in% c(ymd("2023-10-01"), ymd("2024-03-01")))

##Make table for overall Acropora mortality for each subregion
subregionTableRegion <- out.glmer %>%
  pivot_wider(id_cols = subregion, names_from = date, values_from = prob)

out.glmer %>%
  dplyr::select(subregion, date, prob) %>%
  pivot_wider(values_from = prob, names_from = date) %>%
  knitr::kable(caption = "Mortality from GLMER")

```

## Plot mortality over time for all Acropora on map
```{r}
# Alter map extent to create space for adding graphs on top of map
mapfig2 <- basemap +
  geom_point(data = dfs, aes(x = lon, y = lat, color = subregion, size = maxn_cat, shape = species), alpha = 0.4) +
  coord_sf(xlim = c(-83.5, -79), ylim = c(23.6, 26.5), expand = FALSE) +
  theme(legend.position = "none")


# Create DHW plot to draw as inset on map
dhwmean <- read_csv("data/processed/MeanDHW_subregions.csv")
out <- read_csv("data/processed/DHW_siteclusts.csv")
new_dates <- seq.Date(from = as.Date("2024-01-01"), to = as.Date("2024-03-01"), by = "day")
new_data <- expand_grid(date = new_dates, subregion = levels(dhwmean$subregion), dhw = 0)
dhwmean <- bind_rows(dhwmean, new_data)
library(ggh4x)
dhwfig <- ggplot(out, aes(x = date, y = dhw, color = subregion)) +
  geom_line(aes(group = siteclust), lwd = 0.2, alpha = 0.5) +
  geom_line(data = dhwmean, lwd = 2, alpha = 0.6) +
  geom_segment(x = as.Date("2023-10-01"), xend = as.Date("2023-10-01"), y = -1, yend = 22, lty = 2, lwd = 0.1, color = "black") +
  geom_segment(x = as.Date("2024-03-01"), xend = as.Date("2024-03-01"), y = -1, yend = 9, lty = 2, lwd = 0.1, color = "black") +
  annotate("text", x = c(as.Date("2023-10-01"), as.Date("2024-03-01")), y = c(2, 2), 
           label = c(expression(italic(t)[1]), expression(italic(t)[2])), hjust = 1.3) +
  scale_x_date(breaks = as.Date(c("2023-06-01", "2023-10-01", "2024-03-01")), date_labels = "%b-%y",
               date_minor_breaks = "1 month", guide = "axis_minor") +
  labs(x = "", y = "Degree Heating Weeks (Â°C-weeks)") +
  theme_classic() +
  theme(legend.position = "none",
        axis.line = element_line(size = 0.1),
        axis.ticks = element_line(size = 0.1),
        axis.title.y = element_text(size = 8),
        plot.background = element_blank(),
        panel.background = element_blank(),
        ggh4x.axis.ticks.length.minor = rel(1))


# Create barplots of mortality at t1 and t2 for each subregion
bars <- out.glmer %>%
  dplyr::select(subregion, date, dead = prob, asymp.LCL, asymp.UCL) %>%
  mutate(alive = 1 - dead, subregion2 = subregion) %>%
  pivot_longer(c(dead, alive), names_to = "cat", values_to = "val") %>%
  left_join(counts1) %>%
  nest(data = -subregion) %>%
  mutate(barplots = map(data, ~ggplot(., aes(x = factor(date))) +
             geom_col(aes(y = val, fill = cat), color = "black", lwd = 0.1) +
             geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), lwd = 0.1, width = 0.1) +
             geom_text(aes(x = 1.5, y = 1, label = paste(subregion2, "\n", "n =", maxtot), color = subregion2), vjust = -0.25, size = 2) +
             scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.25), labels = c("0%", "", "50%", "", "100%")) +
             scale_x_discrete(labels = c(expression(italic(t)[1]), expression(italic(t)[2]))) +
             scale_color_manual(values = c("#F8766D","#B79F00","#00BA38","#00BFC4","#619CFF","#F564E3"), drop = FALSE) +
             scale_fill_manual(values = c("#a6d96a", "#de2d26")) +
             labs(x = "", y = "") +
             coord_cartesian(clip = 'off') +
             theme_classic() +
             theme(legend.position = "none", 
                   axis.line = element_line(size = 0.1),
                   axis.ticks = element_line(size = 0.1),
                   plot.background = element_blank(), 
                   panel.background = element_blank(),
                   axis.text.x = element_text(angle = 0, hjust = c(0.5, 0.5)),
                   axis.text.y = element_text(size = 5))))

bars$barplots[[6]] <- bars$barplots[[6]] +
  labs(y = expression(italic("Acropora spp.")~mortality)) +
  theme(axis.title.y = element_text(size = 8))

# Plot mortality barplots on top of the map
outmapbars <- ggdraw() +
  draw_plot(mapfig2) +
  draw_plot(bars$barplots[[1]], height = 0.25, width = 0.2, x = 0.775, y = 0.65) +
  draw_plot(bars$barplots[[2]], height = 0.25, width = 0.2, x = 0.775, y = 0.41) +
  draw_plot(bars$barplots[[3]], height = 0.25, width = 0.2, x = 0.675, y = 0.18) +
  draw_plot(bars$barplots[[4]], height = 0.25, width = 0.2, x = 0.5, y = 0.075) +
  draw_plot(bars$barplots[[5]], height = 0.25, width = 0.2, x = 0.3, y = 0.05) +
  draw_plot(bars$barplots[[6]], height = 0.25, width = 0.2, x = 0.1, y = 0.05)

# Display map figure with additional plots
(outmap3 <- outmapbars +
  draw_plot(dhwfig, height = 0.48, width = 0.4, x = 0.1, y = 0.445))

# Save
ggsave("outmap3.png", plot = outmap3, width = 183, height = 140, units = "mm")
```



# Mortality vs. DHW -- ACER vs. APAL and Wild vs. Outplant

### Plot mortality vs. DHW data
```{r}
dff <- df %>% filter(coral_type != "Wild/Outplant")

mortdhwplot <- ggplot(dff, aes(x = cummaxdhw, y = pct_mort)) +
  geom_point(aes(size = n_total)) +
  facet_wrap(~species + coral_type)
mortdhwplot

```

### Model mortality vs. DHW by species

#### GLM and GLMER
```{r}
# # Model species vs dhw for GLM
modDhwGlm <- glm(cbind(n_dead, n_alive) ~ cummaxdhw * species * coral_type, family = "binomial", data = dff)
#predict data for GLM
resDhwGlm <- emmeans(modDhwGlm, specs = "cummaxdhw", by = c("species", "coral_type"), type = "response", interval = "prediction",
               at = list(cummaxdhw = seq(0, 25, 0.1))) %>%
  as_tibble(.) %>%
  mutate(type="glm")


# Model species vs dhw for GLMER
mod.dhw.glmer <- glmer(cbind(n_dead, n_alive) ~ cummaxdhw * species + (1|subregion),# (1|siteclust/species),
                   family = binomial,
                   data = dff)
car::Anova(mod.dhw.glmer)
#predict data for GLMM
dhwGlmerRes <- emmeans(mod.dhw.glmer, specs = "cummaxdhw", by = c("species"), type = "response", interval = "prediction",
               at = list(cummaxdhw = seq(0, 23, 0.1))) %>%
  as_tibble(.)%>%
  mutate(type="glmer")

ggplot(dhwGlmerRes, aes(x = cummaxdhw, y = prob)) +
  geom_line(aes(color = species)) +
  geom_point(data = dff, aes(y = pct_mort, color = species))


# Percent mortality w/ maxDHW
mortdhwplot +
  #geom_point(aes(size = log10(n_total), shape = species, color = subregion), alpha = 0.3) +
  #scale_size_discrete(range = c(1,4)) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Peak DHW", y = "Mortality") +
  theme_classic(base_size=16) +
  geom_line(data = as_tibble(dhwGlmerRes), aes(y = prob, color = species),  lty = 2) +
  geom_line(data = as_tibble(resDhwGlm), aes(y = prob, color = species), lty = 1)
```

#### Dose-response curves
```{r}
# Dose-response curves
library(drc)
# Fit 4-parameter log-logistic dose-response curves for mortality as function of DHW, by species, with min=0 and max=1
m3 <- drm(pct_mort ~ cummaxdhw, data = dff, curveid = species, weights = n_total, type = "binomial",
         logDose = NULL, fct = LL.4(
           names = c("hill", "min", "max", "ED50"),
           ## Max parameter is fixed to 1, min is set to 0
           fixed = c(NA, 0, 1, NA)))
# Get fitted values and plot
nd <- expand.grid(species = unique(dff$species), cummaxdhw = seq(0, 23, 0.1))
pred <- predict(m3, newdata = nd, interval = "confidence", level = 0.99)
drc.res <- as_tibble(bind_cols(nd, pred))
ggplot(drc.res, aes(x = cummaxdhw, y = Prediction)) +
  geom_line(aes(color = species)) +
  geom_point(data = dff, aes(y = pct_mort, color = species)) +
  geom_hline(yintercept = c(0.5, 0.95), lty = 2, lwd = 0.25) +
  labs(x = "Max DHW", y = "Mortality", title = "APAL vs. ACER")

# Get ED50s and ED95s
eds <- ED(m3, c(0.5, 0.95), type = "absolute", interval = "delta", level = 0.95)
as.tibble(eds, )
eds.res <- rownames_to_column(data.frame(eds), "par") %>% as_tibble() %>%
  separate(par, sep = ":", into = c("par", "species", "level"))

# Plot ED50s and ED95s with confidence intervals
ggplot(eds.res, aes(x = level, y = Estimate, color = species)) +
  geom_point() +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), width = 0.25) +
  labs(x = "Mortality level", y = "DHW")
```

#### APAL: Model mortality vs. DHW for outplants and wild colonies
```{r}
# For APAL, model outplant vs. wild
apal <- subset(dff, species == "APAL")
# Fit 4-parameter log-logistic dose-response curves for mortality as function of DHW, by species, with min=0 and max=1
apal.m3 <- drm(pct_mort ~ cummaxdhw, data = apal, curveid = coral_type, weights = n_total, type = "binomial",
         logDose = NULL, fct = LL.4(
           names = c("hill", "min", "max", "ED50"),
           ## Max parameter is fixed to 1, min is set to 0
           fixed = c(NA, 0, 1, NA)))
# Get fitted values and plot
apal.nd <- expand.grid(coral_type = c("Outplant", "Wild"), cummaxdhw = seq(0, 23, 0.1))
apal.pred <- predict(apal.m3, newdata = apal.nd)
apal.drc.res <- as_tibble(bind_cols(apal.nd, prob = apal.pred))
ggplot(apal.drc.res, aes(x = cummaxdhw, y = prob)) +
  geom_line(aes(color = coral_type)) +
  geom_point(data = apal, aes(y = pct_mort, color = coral_type)) +
  geom_hline(yintercept = c(0.5, 0.95), lty = 2, lwd = 0.25) +
  labs(x = "Max DHW", y = "Mortality", title = "APAL Wild vs. Outplant")
```

### Plot Mortality vs. DHW DRCs by species with ED50s and ED95s

```{r plot_drc}
#plot just drc values for each species 
library(ggtext)
ggplot(drc.res, aes(x = cummaxdhw, y = Prediction, color = species)) +
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.2, lwd = 0) +
  geom_line(size = 1.2) +
  geom_hline(yintercept = c(0.5, 0.95), linetype = 2, lwd = 0.25) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = "Peak DHW", y = "Mortality") +
  theme_classic(base_size = 16) +
  scale_color_brewer(palette = "Set2", name = "", labels = c("*A. cervicornis*", "*A. palmata*")) +
  geom_text(data=eds.res, aes(label = round(as.numeric(Estimate), 1), x = Estimate, y = as.numeric(level)), 
                   show.legend = F, size= 6,
            nudge_x = c(2, 2, -1.5, -2),
            nudge_y = c(0.05, -0.05, 0.05, 0.05)) +
  theme(legend.position = c(0.8, 0.15), legend.text = element_markdown())

#ggsave("outputs/mortalityDhwEstimates_glmm.png", width=8)
```






#### Add in total percent mortality model
```{r}
# Fit model using glmer (sites as random factors)
mod.glmer.noRegion.noSpec <- glmer(cbind(n_dead, n_alive) ~ date_scaled + (1|subregion/siteclust),  # OR (1|siteclust/species)
                       family = binomial, data = df)

mod.glmer.noRegion.Spec <- df %>%
  #filter(subregion!="Broward-Miami")%>%
  glmer(cbind(n_dead, n_alive) ~ species*date_scaled + (1|subregion/siteclust),  # OR (1|siteclust/species)
                       family = binomial, data = .)


#species matters so keep
date_ranges_scaled_nosub <- df %>%
  group_by(species) %>%
  summarize(start = min(date_scaled), end = max(date_scaled))

# Fitted values for glmer
res.all.glmer.noRegion <- emmeans(mod.glmer.noRegion.Spec, specs = c("date_scaled", "species"), type = "response",
                         at = list(date_scaled = seq(-2.699, 2.167, 0.015)))

#
res.all.glmer.noRegion.spec <- as.tibble(res.all.glmer.noRegion ) %>%
  group_by(species) %>%
  nest() %>%
  left_join(date_ranges_scaled_nosub) %>%
  mutate(data.f = pmap(list(data, start, end), function(data, start, end) data %>% filter(date_scaled > start))) %>% #, date < end))) %>%
  dplyr::select(species, data.f) %>%
  unnest(data.f) %>%
  mutate(date = as_date(date_scaled * datesd + datemean))


#get output
out.glmer.total.Species.noRegion <- as.tibble(res.all.glmer.noRegion.spec ) %>%
  mutate(date=ymd(date))%>%
  filter(date %in% c(ymd("2023-10-01"), ymd("2024-03-01")))

wideSpeciesTotalMortality <- out.glmer.total.Species.noRegion %>%
  dplyr::select(species, date, dead = prob, asymp.LCL, asymp.UCL) %>%
  mutate(alive = 1 - dead) %>%
  pivot_longer(c(dead, alive), names_to = "cat", values_to = "val") 

#plot  total mortality simliar to map figure 
ggplot(wideSpeciesTotalMortality, aes(x=factor(date)))+
             geom_col(aes(y = val, fill = cat), color = "black", lwd = 0.1) +
             geom_errorbar(aes(ymin = asymp.LCL, ymax = asymp.UCL), lwd = 0.1, width = 0.1) +
  facet_wrap(~species)+
  geom_text(aes(label=round(prob, 2)), y= 0.75, data=out.glmer.total.Species.noRegion, hjust=0.5)+
             #geom_text(aes(x = 1.5, y = 1, label = paste(subregion2, "\n", "n =", maxtot), color = subregion2), vjust = -0.25, size = 2) +
             scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.25), labels = c("0%", "", "50%", "", "100%")) +
             scale_x_discrete(labels = c(expression(italic(t)[1]), expression(italic(t)[2]))) +
             scale_color_manual(values = c("#F8766D","#B79F00","#00BA38","#00BFC4","#619CFF","#F564E3"), drop = FALSE) +
             scale_fill_manual(values = c("#a6d96a", "#de2d26")) +
             labs(x = "", y = "") +
             coord_cartesian(clip = 'off') +
             theme_classic(base_size = 18) +
             theme(legend.position = "none", 
                   axis.line = element_line(size = 0.1),
                   axis.ticks = element_line(size = 0.1),
                   plot.background = element_blank(), 
                   panel.background = element_blank(),
                   axis.text.x = element_text(angle = 0, hjust = c(0.5, 0.5)),
                   axis.text.y = element_text(size = 5))

#ggsave("outputs/speciesTotalMort.png")
```

